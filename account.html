<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî A Book Written With Soul</title>

<link href="https://fonts.googleapis.com/css2?family=Spectral+SC:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

<!-- JSZip (–¥–ª—è ZIP –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<!-- Supabase JS (–∫–ª–∏–µ–Ω—Ç) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>

<style>
:root{
  --ink:#e9dcc9; --muted:#b8a589;
  --gold1:#e6d2aa; --gold2:#b99261; --gold3:#8a6948;
  --panel:#171311; --panel2:#120f0d;
}

/* base */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Playfair Display",serif; color:var(--ink);
  background:
    linear-gradient(rgba(10,8,6,.72), rgba(10,8,6,.72)),
    url("assets/background4.jpg") center/cover fixed no-repeat;
  min-height:100svh; overflow-x:hidden; padding-bottom:86px;
  position:relative;
}
body::before{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:1;
  background-image:url("https://www.transparenttextures.com/patterns/asfalt-light.png");
  opacity:.11; mix-blend-mode:overlay;
}

/* header */
.header{
  display:flex; flex-direction:column; align-items:center; gap:2px;
  padding:14px 10px 6px; position:relative; z-index:3;
}
.logo-book{ font-size:28px; animation:breath 6s ease-in-out infinite; will-change:transform; }
@keyframes breath{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-2px) scale(1.01)}}
.header-title{
  font-family:"Spectral SC",serif; font-size:16px; letter-spacing:.06em;
  background:linear-gradient(90deg,#d9c29a,#b99363,#e9d6b5);
  -webkit-background-clip:text; color:transparent; text-shadow:0 1px 0 rgba(0,0,0,.35);
}

/* sections */
.section{padding:14px 12px; position:relative; z-index:2}
.card{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px; padding:16px; box-shadow:0 22px 60px rgba(0,0,0,.38);
}

/* titles */
.block-title{
  font-family:"Spectral SC",serif; color:#e7d6ba; margin-bottom:10px; opacity:.95
}

/* profile */
.profile-row{display:flex; gap:12px; align-items:center}
.avatar{
  width:56px;height:56px;border-radius:50%; display:grid;place-items:center;
  background:linear-gradient(145deg,#1b1613,#0e0b09); color:var(--ink); font-weight:700;
  border:1px solid rgba(255,255,255,.08);
}
.small{font-size:12px;color:var(--muted)}
.stat{margin-top:10px;display:flex;align-items:center;gap:10px}
.ring{width:56px;height:56px;rotate:-90deg}
.ring circle.bg{stroke:#2a221a; stroke-width:7; fill:none}
.ring circle.fg{stroke:url(#g); stroke-width:7; stroke-linecap:round; fill:none; transition:stroke-dashoffset .35s}
.btn{
  border:none; cursor:pointer; color:#241b13; font-weight:700;
  border-radius:999px; padding:12px 16px; font-size:16px;
  background:linear-gradient(130deg,var(--gold2),var(--gold1));
  box-shadow:0 12px 36px rgba(0,0,0,.4);
}
.btn:active{transform:translateY(1px)}
.sep{height:1px;background:rgba(255,255,255,.06);margin:14px 0}

/* covers (carousel) */
.covers.card{padding:18px}
.scroller{
  display:flex; gap:12px; overflow-x:auto; scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch; padding-bottom:6px;
}
.scroller::-webkit-scrollbar{height:8px}
.scroller::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14); border-radius:8px}
.cover{
  min-width:130px; aspect-ratio:3/4; border-radius:12px; position:relative; overflow:hidden;
  background:radial-gradient(240px 120px at 50% 30%, #3a2f25,#1a1511);
  border:1px solid rgba(255,255,255,.08); scroll-snap-align:center;
  box-shadow:0 18px 40px rgba(0,0,0,.45); transform:translateZ(0); cursor:pointer;
}
.cover.gold{ background: radial-gradient(240px 120px at 50% 30%, #876b49,#3b2f24) }
.cover.sand{ background: radial-gradient(240px 120px at 50% 30%, #746a59,#2a2520) }
.cover .badge{
  position:absolute; right:8px; bottom:8px; font-size:12px; padding:6px 8px;
  border-radius:999px; background:rgba(0,0,0,.4); color:#efdcb8; border:1px solid rgba(255,255,255,.08)
}
.cover.selected{outline:2px solid #d4b37c; box-shadow:0 0 0 4px rgba(212,179,124,.15)}
.cover img{width:100%;height:100%;object-fit:cover;display:block}

/* questions */
.q{margin-top:12px; border:1px solid rgba(255,255,255,.06); border-radius:14px; overflow:hidden}
.qh{
  padding:14px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;
  background:linear-gradient(180deg,#171311,#14110f);
}
.qh .num{color:#bda989; font-family:"Spectral SC",serif}
.qa{display:none; padding:14px; background:linear-gradient(180deg,#14110f,#120f0d)}
.qa textarea{
  width:100%; min-height:120px; border-radius:12px; border:1px solid rgba(255,255,255,.06);
  background:#100d0b; color:var(--ink); resize:vertical; padding:12px; font-size:16px;
}
.hint{font-size:12px;color:var(--muted); margin-top:8px}
.tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
.tag{background:#0f0c0a; border:1px dashed rgba(255,255,255,.1); color:#c9b89a; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer}

/* photos */
.uploader .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pbtn{border:none;border-radius:999px;padding:10px 14px;background:linear-gradient(130deg,var(--gold2),var(--gold1));color:#241b13;font-weight:700;cursor:pointer}
#photoInput{display:none}
.preview{display:flex;flex-wrap:wrap;gap:10px}
.pv{position:relative;width:86px;height:86px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 24px rgba(0,0,0,.25)}
.pv img{width:100%;height:100%;object-fit:cover}
.pv .del{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;display:grid;place-items:center;cursor:pointer;font-size:13px}

/* chat support (floating) */
.chatfab{
  position:fixed; right:14px; bottom:90px; z-index:10;
  width:54px;height:54px;border-radius:50%; display:grid;place-items:center;
  background:linear-gradient(130deg,var(--gold2),var(--gold1)); color:#241b13;
  box-shadow:0 16px 44px rgba(0,0,0,.5); cursor:pointer;
}
.chat{
  position:fixed; right:14px; bottom:154px; width:86vw; max-width:360px;
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid rgba(255,255,255,.08); border-radius:14px; display:none; flex-direction:column; overflow:hidden;
  box-shadow:0 24px 60px rgba(0,0,0,.55); z-index:20;
}
.chat-head{padding:10px 12px; display:flex; justify-content:space-between; align-items:center; background:#171311; border-bottom:1px solid rgba(255,255,255,.06)}
.chat-body{max-height:45svh; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px}
.msg{font-size:14px; background:#100d0b; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; width:max-content; max-width:100%}
.msg.you{align-self:flex-end; background:linear-gradient(130deg,var(--gold2),var(--gold1)); color:#241b13; border:none}
.chat-send{display:flex; gap:6px; padding:10px; background:#171311; border-top:1px solid rgba(255,255,255,.06)}
.chat-send input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0f0d0b; color:var(--ink)}
.chat-send button{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(130deg,var(--gold2),var(--gold1)); color:#241b13; font-weight:700}

/* bottom nav (–∫–æ–Ω—Ç—É—Ä–Ω—ã–µ svg) */
.navbar{
  position:fixed;bottom:0;left:0;right:0;z-index:15;
  background:linear-gradient(180deg, rgba(18,15,13,.85), rgba(16,13,11,.85));
  backdrop-filter:blur(10px);
  display:flex; gap:8px; padding:8px; border-top:1px solid rgba(255,255,255,.06);
}
.nav-item{
  flex:1; text-align:center; padding:10px 6px; border-radius:12px; cursor:pointer; user-select:none;
  border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(20,17,15,.7), rgba(17,14,12,.7));
  color:#d8c6a3; font-size:12px;
}
.nav-item .icon{display:block; margin:0 auto 4px; width:20px; height:20px}
.nav-item svg{width:20px;height:20px;stroke:#d6c39b;fill:none;stroke-width:1.6;filter:drop-shadow(0 0 3px rgba(214,195,155,.18));transition:.25s}
.nav-item.active{outline:1px solid #d4b37c; box-shadow:0 0 0 4px rgba(212,179,124,.12)}
.nav-item.active svg{stroke:#f1e4c5;stroke-width:2;filter:drop-shadow(0 0 6px rgba(241,228,197,.36))}

/* reveal on scroll */
.reveal{opacity:0;transform:translateY(12px);transition:opacity .6s ease, transform .6s ease}
.reveal.show{opacity:1;transform:none}
</style>
</head>
<body>

<!-- PUBLIC Supabase (–≤—Å—Ç–∞–≤—å —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è) -->
<script>
  window.PUBLIC_SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  window.PUBLIC_SUPABASE_ANON = "YOUR-ANON-KEY";
</script>

<!-- Header -->
<header class="header">
  <div class="logo-book" aria-label="logo">üìñ</div>
  <div class="header-title">A Book Written With Soul</div>
</header>

<!-- PROFILE -->
<section id="sec-profile" class="section reveal">
  <div class="card">
    <div class="block-title">–í–∞—à –∫–∞–±–∏–Ω–µ—Ç</div>
    <div class="profile-row">
      <div class="avatar" id="avatar">AB</div>
      <div>
        <div class="small">token: <span id="utoken">‚Äî</span></div>
        <div class="stat">
          <svg class="ring" viewBox="0 0 44 44" aria-hidden="true">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#e6d2aa"/><stop offset="100%" stop-color="#b99261"/>
              </linearGradient>
            </defs>
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle class="fg" id="pfg" cx="22" cy="22" r="18" stroke-dasharray="113.1" stroke-dashoffset="113.1"></circle>
          </svg>
          <div class="small"><b><span id="done">0</span>/100</b> –æ—Ç–≤–µ—Ç–æ–≤</div>
        </div>
      </div>
    </div>
    <div class="sep"></div>
    <button class="btn" id="finish">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
  </div>
</section>

<!-- COVERS (carousel + –≤—ã–±–æ—Ä) -->
<section id="sec-covers" class="section reveal">
  <div class="card covers">
    <div class="block-title">–í—ã–±–µ—Ä–∏ –æ–±–ª–æ–∂–∫—É –±—É–¥—É—â–µ–π –∫–Ω–∏–≥–∏</div>
    <div class="scroller" id="coversRow" aria-label="–ö–∞—Ä—É—Å–µ–ª—å –æ–±–ª–æ–∂–µ–∫">
      <!-- —É–∫–∞–∂–∏ —Å–≤–æ–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –æ–±–ª–æ–∂–µ–∫ -->
      <div class="cover gold selected" data-key="gold"><span class="badge">Gold</span><img src="assets/cover1.jpg" alt="Gold"></div>
      <div class="cover" data-key="classic"><span class="badge">Classic</span><img src="assets/cover2.jpg" alt="Classic"></div>
      <div class="cover sand" data-key="sand"><span class="badge">Sand</span><img src="assets/cover3.jpg" alt="Sand"></div>
      <div class="cover" data-key="ivory"><span class="badge">Ivory</span><img src="assets/cover4.jpg" alt="Ivory"></div>
      <div class="cover" data-key="noir"><span class="badge">Noir</span><img src="assets/cover5.jpg" alt="Noir"></div>
    </div>
    <div class="small" style="margin-top:8px">–õ–∏—Å—Ç–∞–π —Å–≤–∞–π–ø–æ–º ‚Äî –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–π: –º—ã –º—è–≥–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã. –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å.</div>
  </div>
</section>

<!-- QUESTIONS -->
<section id="sec-questions" class="section reveal">
  <div class="card">
    <div class="block-title">–í–æ–ø—Ä–æ—Å—ã</div>
    <div id="qlist"></div>
  </div>
</section>

<!-- PHOTOS -->
<section id="sec-photos" class="section reveal">
  <div class="card uploader">
    <div class="head">
      <div class="block-title" style="margin:0">–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</div>
      <button class="pbtn" id="pick">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</button>
      <input id="photoInput" type="file" accept="image/*" multiple>
    </div>
    <div class="small">–¥–æ 20 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>
    <div class="preview" id="preview"></div>
    <div class="small" id="pcounter" style="margin-top:6px">0 —Ñ–æ—Ç–æ</div>
  </div>
</section>

<!-- FINISH MODAL -->
<section id="sec-finish" class="section reveal" style="display:none">
  <div class="card" id="finishCard">
    <div class="block-title">–í–∞—à–∞ –∫–Ω–∏–≥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è</div>
    <p style="opacity:.9">
      –ú—ã —Å –ª—é–±–æ–≤—å—é —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç <b>7‚Äì14 –¥–Ω–µ–π</b>.
    </p>
    <p class="small" style="margin-top:8px">–ú—ã –Ω–∞–ø–∏—à–µ–º –≤–∞–º –≤ Telegram, –∫–æ–≥–¥–∞ –∫–Ω–∏–≥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é.</p>
  </div>
</section>

<!-- Support floating -->
<div class="chatfab" id="chatFab" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">
  <svg viewBox="0 0 24 24" style="width:22px;height:22px"><path d="M4 4h16v12H5.17L4 17.17z"/><circle cx="8.5" cy="10.5" r=".75"/><circle cx="12" cy="10.5" r=".75"/><circle cx="15.5" cy="10.5" r=".75"/></svg>
</div>
<div class="chat" id="chatBox" role="dialog" aria-label="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">
  <div class="chat-head"><b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</b><span id="chatClose" style="cursor:pointer;opacity:.7">‚úñ</span></div>
  <div class="chat-body" id="chatMessages"></div>
  <div class="chat-send">
    <input id="chatInput" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å‚Ä¶">
    <button id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<!-- Bottom nav -->
<nav class="navbar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
  <div class="nav-item active" data-target="sec-profile">
    <span class="icon">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
    </span>
    –ü—Ä–æ—Ñ–∏–ª—å
  </div>
  <div class="nav-item" data-target="sec-covers">
    <span class="icon">
      <svg viewBox="0 0 24 24"><rect x="4" y="4" width="8" height="16" rx="2"/><rect x="12" y="4" width="8" height="16" rx="2"/></svg>
    </span>
    –û–±–ª–æ–∂–∫–∞
  </div>
  <div class="nav-item" data-target="sec-questions">
    <span class="icon">
      <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h10M4 18h7"/></svg>
    </span>
    –í–æ–ø—Ä–æ—Å—ã
  </div>
  <div class="nav-item" data-target="sec-photos">
    <span class="icon">
      <svg viewBox="0 0 24 24"><circle cx="8.5" cy="8.5" r="2.5"/><path d="M20 5h-3l-2-2H9L7 5H4v14h16z"/></svg>
    </span>
    –§–æ—Ç–æ
  </div>
  <div class="nav-item" data-target="#support-open">
    <span class="icon">
      <svg viewBox="0 0 24 24"><path d="M4 4h16v12H5.17L4 17.17z"/><circle cx="8.5" cy="10.5" r=".75"/><circle cx="12" cy="10.5" r=".75"/><circle cx="15.5" cy="10.5" r=".75"/></svg>
    </span>
    –ü–æ–¥–¥–µ—Ä–∂–∫–∞
  </div>
</nav>

<script>
/* ====== PUBLIC Supabase client ====== */
const supabase = window.supabase.createClient(
  window.PUBLIC_SUPABASE_URL,
  window.PUBLIC_SUPABASE_ANON
);

/* ====== Helpers ====== */
const LS=(k,v)=>v===undefined?localStorage.getItem(k):localStorage.setItem(k,v);
const params=new URL(location.href).searchParams;
const token=params.get("token")||"DEMO-TOKEN";
document.getElementById("utoken").textContent=token;

(function setInitials(){
  const clean=token.replace(/[^a-zA-Z–ê-–Ø–∞-—è0-9]/g,"").toUpperCase();
  const ini=(clean[0]||"A")+(clean[1]||"B");
  document.getElementById("avatar").textContent = ini;
})();

/* ====== Reveal on scroll ====== */
const io=new IntersectionObserver(entries=>{
  entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('show'); });
},{threshold:.15});
document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

/* ====== Bottom nav scroll ====== */
document.querySelectorAll(".nav-item").forEach(n=>{
  n.onclick=()=>{
    const t=n.getAttribute("data-target");
    if(t==="#support-open"){openChat();return;}
    document.getElementById(t)?.scrollIntoView({behavior:"smooth",block:"start"});
    document.querySelectorAll(".nav-item").forEach(x=>x.classList.remove("active"));
    n.classList.add("active");
  };
});

/* ====== Covers: auto-slide carousel + select + sync ====== */
const coversRow=document.getElementById("coversRow");
let chosenCover = LS(`cover_${token}`) || "gold";
function markCover(){
  document.querySelectorAll('.cover').forEach(c=>{
    c.classList.toggle('selected', c.dataset.key===chosenCover);
  });
}
markCover();

document.querySelectorAll('.cover').forEach(c=>{
  c.addEventListener('click', async ()=>{
    chosenCover = c.dataset.key;
    LS(`cover_${token}`, chosenCover);
    markCover();
    // sync to server
    await fetch('/api/saveCover',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token, cover_key: chosenCover})
    });
  });
});

let autoTimer=setInterval(autoSlide, 5000);
function autoSlide(){
  const step = coversRow.firstElementChild?.getBoundingClientRect().width || 140;
  coversRow.scrollBy({left: step+12, behavior:"smooth"});
  if(coversRow.scrollLeft + coversRow.clientWidth >= coversRow.scrollWidth - 2){
    setTimeout(()=>coversRow.scrollTo({left:0,behavior:"smooth"}), 600);
  }
}
["touchstart","mousedown","wheel"].forEach(ev=>{
  coversRow.addEventListener(ev, ()=>{clearInterval(autoTimer); autoTimer=setInterval(autoSlide,5000);},{passive:true});
});

/* ====== Questions (accordion + autosave + sync) ====== */
const QUESTIONS_BASE=[
 "–ì–¥–µ –≤—ã –≤–ø–µ—Ä–≤—ã–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å?",
 "–ß—Ç–æ –≤—ã –ø–æ–¥—É–º–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –≤—Å—Ç—Ä–µ—á–µ?",
 "–ö—Ç–æ —Å–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π —à–∞–≥?",
 "–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Å—Ç–∞–ª —Ä–µ—à–∞—é—â–∏–º?",
 "–ß—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å?"
];
while(QUESTIONS_BASE.length<100) QUESTIONS_BASE.push(`–í–æ–ø—Ä–æ—Å ${QUESTIONS_BASE.length+1}`);
const total=QUESTIONS_BASE.length;
const qlist=document.getElementById("qlist");

function keyAns(i){return `cab_${token}_a_${i}`}

function renderQuestions(answersMap={}){
  qlist.innerHTML="";
  let done=0;
  QUESTIONS_BASE.forEach((q,i)=>{
    const local=LS(keyAns(i)) ?? "";
    const synced = answersMap[i] ?? "";
    const initial = local || synced || "";
    if(initial.trim().length>=3) done++;
    qlist.insertAdjacentHTML("beforeend",`
      <div class="q" data-i="${i}">
        <div class="qh" onclick="toggleQ(${i})">
          <div><span class="num">${i+1}/${total}</span> ‚Äî ${q}</div>
          <div>${initial.trim().length>=3?"‚úÖ":"‚ñ∏"}</div>
        </div>
        <div class="qa" id="qa_${i}" style="${i<1?'display:block':''}">
          <textarea id="ta_${i}" placeholder="–í–∞—à —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç...">${initial}</textarea>
          <div class="hint">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Ä¢ –ü–æ–¥—Å–∫–∞–∑–∫–∏:</div>
          <div class="tags">
            <div class="tag" onclick="ins(${i},'–í—Å–ø–æ–º–∏–Ω–∞—é, –∫–∞–∫ –º—ã...')">–í—Å–ø–æ–º–∏–Ω–∞—é‚Ä¶</div>
            <div class="tag" onclick="ins(${i},'–û—Å–æ–±–µ–Ω–Ω–æ —Ç—Ä–æ–Ω—É–ª –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞...')">–¢—Ä–æ–Ω—É–ª –º–æ–º–µ–Ω—Ç‚Ä¶</div>
            <div class="tag" onclick="ins(${i},'–Ø –ø–æ–Ω—è–ª(–∞), —á—Ç–æ —ç—Ç–æ –ª—é–±–æ–≤—å, –∫–æ–≥–¥–∞...')">–≠—Ç–æ –ª—é–±–æ–≤—å‚Ä¶</div>
          </div>
        </div>
      </div>
    `);
    const ta=document.getElementById(`ta_${i}`);
    ta.addEventListener("input",()=>debounce(`a${i}`,()=>saveAnswer(i, ta.value), 450));
    ta.addEventListener("keydown",e=>{
      if(e.key==="Enter" && e.metaKey){ e.preventDefault(); toggleQ(i+1); }
    });
  });
  updateProgress();
}

function debounceInit(){ const timers={}; return (id,fn,ms=400)=>{clearTimeout(timers[id]); timers[id]=setTimeout(fn,ms);} }
const debounce=debounceInit();

function toggleQ(i){
  const el=document.getElementById(`qa_${i}`);
  if(!el) return;
  const is=el.style.display!=="none";
  document.querySelectorAll(".qa").forEach(x=>x.style.display="none");
  el.style.display = is ? "none" : "block";
  if(!is){ document.getElementById(`ta_${i}`).focus(); el.scrollIntoView({behavior:"smooth",block:"center"}); }
}
function ins(i,txt){
  const ta=document.getElementById(`ta_${i}`);
  ta.value = (ta.value?ta.value+"\n":"")+txt;
  saveAnswer(i, ta.value);
}

async function saveAnswer(i, val){
  LS(keyAns(i), val);
  updateProgress();
  // sync to server
  try{
    await fetch('/api/saveAnswer',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token, q_index:i, answer:val})
    });
  }catch(e){}
}

function updateProgress(){
  let done=0; for(let i=0;i<total;i++){ if((LS(keyAns(i))||"").trim().length>=3) done++; }
  document.getElementById("done").textContent=done;
  const per=done/total; const C=2*Math.PI*18;
  const fg=document.getElementById("pfg"); fg.style.strokeDasharray=C; fg.style.strokeDashoffset=C*(1-per);
}

/* –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –≤—Ö–æ–¥–µ */
(async function loadServerAnswers(){
  try{
    const res = await fetch('/api/getAnswers',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({token})});
    const data = await res.json(); // {answers:{ [q_index]: text }}
    renderQuestions(data.answers||{});
  }catch(e){
    renderQuestions({});
  }
})();

/* ====== Photos + ZIP ====== */
const pick=document.getElementById("pick");
const photoInput=document.getElementById("photoInput");
const preview=document.getElementById("preview");
const pcounter=document.getElementById("pcounter");
let files=[];
pick.onclick=()=>photoInput.click();
photoInput.onchange=e=>{ for(const f of e.target.files){ if(files.length<20) files.push(f); } renderPhotos(); };
function renderPhotos(){
  preview.innerHTML="";
  files.forEach((f,i)=>{
    const url=URL.createObjectURL(f);
    const d=document.createElement("div"); d.className="pv";
    d.innerHTML=`<span class="del" title="–£–¥–∞–ª–∏—Ç—å" onclick="delPhoto(${i})">‚úñ</span><img src="${url}">`;
    preview.appendChild(d);
  });
  pcounter.textContent = `${files.length} —Ñ–æ—Ç–æ`;
}
function delPhoto(i){ files.splice(i,1); renderPhotos(); }

/* ====== Support chat (client -> support bot) ====== */
const chatFab=document.getElementById("chatFab");
const chatBox=document.getElementById("chatBox");
const chatClose=document.getElementById("chatClose");
const chatSend=document.getElementById("chatSend");
const chatIn=document.getElementById("chatInput");
const chatMsg=document.getElementById("chatMessages");
function openChat(){ chatBox.style.display="flex"; }
chatFab.onclick=openChat;
chatClose.onclick=()=>chatBox.style.display="none";
chatSend.onclick=sendMsg;
chatIn.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();sendMsg();}});
function pushMsg(who,text){
  const d=document.createElement("div"); d.className="msg "+who; d.textContent=text;
  chatMsg.appendChild(d); chatMsg.scrollTop=chatMsg.scrollHeight;
}
async function sendMsg(){
  const t=chatIn.value.trim(); if(!t) return;
  pushMsg("you", t); chatIn.value="";
  try{
    await fetch('/api/support',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({token, text:t})});
  }catch(e){}
}

/* ====== Finish ====== */
document.getElementById("finish").onclick = async ()=>{
  // —Å–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
  const answers = [];
  for(let i=0;i<total;i++){
    const a = (LS(keyAns(i))||"").trim();
    if(a) answers.push({ q_index:i, question:QUESTIONS_BASE[i], answer:a });
  }
  // ZIP —Ñ–æ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
  const zip = new JSZip();
  const folder = zip.folder("photos");
  for(let i=0;i<files.length;i++){
    const f = files[i];
    const buf = await f.arrayBuffer();
    folder.file(`photo_${String(i+1).padStart(2,'0')}.${(f.name.split('.').pop()||'jpg')}`, buf);
  }
  // —Ñ–∞–π–ª —Å –æ—Ç–≤–µ—Ç–∞–º–∏ (txt)
  const username = (localStorage.getItem('username') || token).replace(/\s+/g,'_');
  const now = new Date();
  const dateStr = now.toISOString().slice(0,10);
  const answersText = answers.map(a=>`[${a.q_index+1}] ${a.question}\n${a.answer}\n`).join('\n');
  zip.file(`answers_${username}_${dateStr}.txt`, answersText);

  const blob = await zip.generateAsync({type:"blob"});
  const b64 = await blobToBase64(blob);

  // –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Üí –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç
  const payload = {
    token,
    username,
    cover_key: chosenCover,
    zip_base64: b64,
    zip_filename: `LoveBook_${username}_${dateStr}.zip`
  };
  const r = await fetch('/api/finish',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  if(r.ok){
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω "–∫–Ω–∏–≥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è"
    document.getElementById('sec-finish').style.display='block';
    document.getElementById('sec-finish').scrollIntoView({behavior:"smooth"});
  }else{
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
};
function blobToBase64(blob){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result.split(',')[1]);
    r.onerror=rej;
    r.readAsDataURL(blob);
  });
}

/* ====== Init user in DB (ensure) ====== */
(async function ensureUser(){
  try{
    await fetch('/api/getAnswers',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({token})});
  }catch(e){}
})();

/* ====== Activate first render ====== */
renderQuestions();

/* ====== Bottom nav active state on scroll ====== */
const secIds=["sec-profile","sec-covers","sec-questions","sec-photos","sec-finish"];
const navItems=document.querySelectorAll('.nav-item');
const secIO=new IntersectionObserver(es=>{
  es.forEach(e=>{
    if(e.isIntersecting){
      const id=e.target.id;
      navItems.forEach(n=>{
        const t=n.getAttribute('data-target');
        n.classList.toggle('active', t===id);
      });
    }
  });
},{threshold:.5});
secIds.forEach(id=>{const el=document.getElementById(id); if(el) secIO.observe(el);});
</script>
</body>
</html>