<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî A Book Written With Soul</title>
<link href="https://fonts.googleapis.com/css2?family=Spectral+SC:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0d0b; --ink:#e9dcc9;
  --soft:#1a1612; --panel:#15110f; --muted:#b8a589;
  --gold1:#e9d7b3; --gold2:#b99261; --gold3:#8a6947;
  --ring:#6c533d;
}
*{box-sizing:border-box;margin:0;padding:0}
body {
  background:
    linear-gradient(rgba(12,10,8,.78), rgba(12,10,8,.78)),
    url("assets/background4.jpg") center/cover fixed no-repeat;
  color: var(--ink);
  min-height: 100svh;
  padding: 18px 12px 80px;
  font-family: "Playfair Display", serif;
  position: relative;
  overflow-x: hidden;
}

/* header */
.header{
  display:flex; justify-content:center; align-items:center; gap:10px;
  margin-bottom:14px; position:sticky; top:8px; z-index:5;
}
.logo{
  width:34px;height:34px;border-radius:50%;
  display:grid;place-items:center;
  background:linear-gradient(145deg,#f3ead5,#c9a876);
  color:#453325; box-shadow:0 6px 22px rgba(0,0,0,.25);
  transform:translateZ(0);
  animation:float 5s ease-in-out infinite;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.title{
  font-family:"Spectral SC",serif; letter-spacing:.06em; font-size:18px;
  background:linear-gradient(90deg,#d9c29a,#b99363,#e9d6b5);
  -webkit-background-clip:text; color:transparent; text-shadow:0 1px 0 rgba(0,0,0,.35);
}

/* layout */
.wrap{max-width:1050px;margin:0 auto;display:grid;grid-template-columns:340px 1fr;gap:18px}
@media(max-width:900px){ .wrap{grid-template-columns:1fr} }

/* cards */
.card{
  background:linear-gradient(180deg,var(--panel),#120f0d);
  border:1px solid rgba(255,255,255,.06);
  border-radius:18px; padding:18px; box-shadow:0 20px 55px rgba(0,0,0,.35);
}

/* profile */
.profile{position:sticky; top:64px}
.header-sm{font-family:"Spectral SC",serif; color:#e7d6ba; margin-bottom:12px; opacity:.9}
.profile-row{display:flex; gap:12px; align-items:center; margin-bottom:10px}
.avatar{
  width:54px;height:54px;border-radius:50%; display:grid; place-items:center;
  background:linear-gradient(145deg,#1c1714,#0e0c0a); color:#e9dcc9; font-weight:700;
  border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
.tok{font-size:13px; color:var(--muted)}
.btn{
  border:none; cursor:pointer; color:#241b13; font-weight:700;
  border-radius:999px; padding:12px 16px; font-size:16px;
  background:linear-gradient(130deg,var(--gold2),var(--gold1));
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.btn:active{transform:translateY(1px)}
.row{display:flex; gap:10px; align-items:center}
.mt{margin-top:12px}

/* circular progress */
.progress{
  display:flex; align-items:center; gap:12px; margin:8px 0 14px;
}
svg.ring{width:56px;height:56px;rotate:-90deg}
.ring circle.bg{stroke:#2a221a; stroke-width:7; fill:none}
.ring circle.fg{stroke:url(#g); stroke-width:7; stroke-linecap:round; fill:none; transition:stroke-dashoffset .35s}
.progress .txt{font-family:"Spectral SC",serif}

/* covers */
.covers{display:grid;grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px}
.cover{
  border-radius:12px; aspect-ratio:3/4; position:relative; cursor:pointer; overflow:hidden;
  border:1px solid rgba(255,255,255,.06);
  background:radial-gradient(250px 120px at 50% 30%, #3a2f25, #1a1511);
}
.cover.gold{ background: radial-gradient(220px 110px at 50% 30%, #876b49,#3b2f24)}
.cover.sand{ background: radial-gradient(220px 110px at 50% 30%, #746a59,#2a2520)}
.badge{
  position:absolute; inset:auto 8px 8px auto; font-size:12px; padding:6px 8px;
  border-radius:999px; background:rgba(0,0,0,.4); color:#efdcb8; border:1px solid rgba(255,255,255,.08)
}
.cover input{position:absolute; inset:0; opacity:0}
.cover.selected{outline:2px solid #d4b37c; box-shadow:0 0 0 4px rgba(212,179,124,.15)}

/* questions */
.q{margin-bottom:12px; border:1px solid rgba(255,255,255,.06); border-radius:14px; overflow:hidden}
.qh{
  padding:14px 14px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;
  background:linear-gradient(180deg,#171311,#14110f);
}
.qh .num{color:#bda989; font-family:"Spectral SC",serif}
.qa{display:none; padding:14px; background:linear-gradient(180deg,#14110f,#120f0d)}
.qa textarea{
  width:100%; min-height:120px; border-radius:12px; border:1px solid rgba(255,255,255,.06);
  background:#100d0b; color:var(--ink); resize:vertical; padding:12px; font-size:16px;
}
.hint{font-size:12px;color:#a89678; margin-top:8px}
.tags{display:flex; gap:8px; flex-wrap:wrap}
.tag{
  background:#0f0c0a; border:1px dashed rgba(255,255,255,.1); color:#c9b89a; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer
}

/* pro mode */
.pro .qh{padding:10px 12px}
.pro .qa textarea{min-height:90px}
.pro .q{margin-bottom:10px}

/* support chat */
.chatfab{
  position:fixed; right:14px; bottom:14px; z-index:10;
  width:52px;height:52px;border-radius:50%; display:grid;place-items:center;
  background:linear-gradient(130deg,var(--gold2),var(--gold1)); color:#241b13;
  box-shadow:0 14px 40px rgba(0,0,0,.4); cursor:pointer;
}
.chat{
  position:fixed; right:14px; bottom:80px; width:320px; max-width:calc(100% - 28px);
  background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:14px; display:none; flex-direction:column; overflow:hidden;
  box-shadow:0 20px 55px rgba(0,0,0,.45); z-index:10;
}
.chat-head{padding:10px 12px; display:flex; justify-content:space-between; align-items:center; background:#171311; border-bottom:1px solid rgba(255,255,255,.06)}
.chat-body{max-height:45svh; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px}
.msg{font-size:14px; background:#100d0b; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; width:max-content; max-width:100%}
.msg.you{align-self:flex-end; background:linear-gradient(130deg,var(--gold2),var(--gold1)); color:#241b13; border:none}
.chat-send{display:flex; gap:6px; padding:10px; background:#171311; border-top:1px solid rgba(255,255,255,.06)}
.chat-send input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0f0d0b; color:var(--ink)}
.chat-send button{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(130deg,var(--gold2),var(--gold1)); color:#241b13; font-weight:700}

/* mobile stacking fix */
@media(max-width:900px){
  .profile{position:static}
}

/* small helpers */
.sep{height:1px;background:rgba(255,255,255,.06);margin:14px 0}
.small{font-size:12px;color:#a89678}
.switch{display:flex; align-items:center; gap:8px; font-size:14px}
.switch input{width:38px;height:22px;appearance:none;background:#2a231d;border-radius:999px;position:relative;outline:none;cursor:pointer;border:1px solid rgba(255,255,255,.08)}
.switch input:checked{background:linear-gradient(130deg,var(--gold2),var(--gold1))}
.switch input::after{content:"";position:absolute;left:2px;top:2px;width:18px;height:18px;background:#0f0d0b;border-radius:50%;transition:.2s}
.switch input:checked::after{left:18px}
/* –ó–æ–ª–æ—Ç–æ–π —à—É–º */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background-image: url("https://www.transparenttextures.com/patterns/asfalt-light.png");
  opacity: .12;
  mix-blend-mode: overlay;
  z-index: 1;
}

/* –ú—è–≥–∫–æ–µ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
body::after {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background: radial-gradient(circle at 50% 0%, rgba(255,230,180,.25), transparent 65%);
  animation: goldGlow 6s ease-in-out infinite alternate;
  opacity: .2;
  z-index: 2;
}

@keyframes goldGlow {
  0%   { opacity:.13; filter:brightness(1); }
  100% { opacity:.28; filter:brightness(1.25); }
}
</style>
</head>
<body>

<header class="header">
  <div class="logo">üìñ</div>
  <div class="title">A Book Written With Soul</div>
</header>

<main class="wrap">
  <!-- PROFILE / LEFT -->
  <section class="card profile" id="profileCard">
    <div class="header-sm">–í–∞—à –∫–∞–±–∏–Ω–µ—Ç</div>

    <div class="profile-row">
      <div class="avatar" id="avatar">AB</div>
      <div>
        <div class="small">token: <span id="utoken">‚Äî</span></div>
        <div class="progress">
          <svg class="ring" viewBox="0 0 44 44">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#e6d2aa"/><stop offset="100%" stop-color="#b99261"/>
              </linearGradient>
            </defs>
            <circle class="bg" cx="22" cy="22" r="18"></circle>
            <circle class="fg" id="pfg" cx="22" cy="22" r="18" stroke-dasharray="113.1" stroke-dashoffset="113.1"></circle>
          </svg>
          <div class="txt"><span id="done">0</span>/<span id="total">100</span></div>
        </div>
      </div>
    </div>

    <button class="btn mt" id="finish">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>

    <div class="sep"></div>

    <div class="switch">
      <label>Pro-—Ä–µ–∂–∏–º</label>
      <input type="checkbox" id="proToggle">
    </div>

    <div class="sep"></div>
    <div class="header-sm">–í—ã–±–æ—Ä –æ–±–ª–æ–∂–∫–∏</div>
    <div class="covers" id="covers">
      <label class="cover gold"><span class="badge">Gold</span><input type="radio" name="cover" value="gold"></label>
      <label class="cover"><span class="badge">Classic</span><input type="radio" name="cover" value="classic"></label>
      <label class="cover sand"><span class="badge">Sand</span><input type="radio" name="cover" value="sand"></label>
    </div>
    <div class="small" style="margin-top:8px">–û–±–ª–æ–∂–∫—É –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –ø–æ–∑–∂–µ.</div>
  </section>

  <!-- QUESTIONS / RIGHT -->
  <section class="card" id="qCard">
    <div class="header-sm">–í–æ–ø—Ä–æ—Å—ã</div>
    <div id="qlist"></div>
  </section>
</main>

<!-- SUPPORT CHAT -->
<div class="chatfab" id="chatFab">üí¨</div>
<div class="chat" id="chatBox">
  <div class="chat-head"><b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</b><span id="chatClose" style="cursor:pointer;opacity:.7">‚úñ</span></div>
  <div class="chat-body" id="chatMessages"></div>
  <div class="chat-send">
    <input id="chatInput" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å‚Ä¶">
    <button id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script>
/* ========= –¥–∞–Ω–Ω—ã–µ / –≤–æ–ø—Ä–æ—Å—ã ========= */
const QUESTIONS = [
 "–ì–¥–µ –≤—ã –≤–ø–µ—Ä–≤—ã–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å?","–ß—Ç–æ –≤—ã –ø–æ–¥—É–º–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –≤—Å—Ç—Ä–µ—á–µ?",
 "–ö—Ç–æ —Å–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π —à–∞–≥?","–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Å—Ç–∞–ª —Ä–µ—à–∞—é—â–∏–º?","–ß—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å?"
];
// –¥–æ–±—å—ë–º –¥–æ 100 –ø—É—Å—Ç—ã–º–∏ –∑–∞–≥–ª—É—à–∫–∞–º–∏
while(QUESTIONS.length<100) QUESTIONS.push(`–í–æ–ø—Ä–æ—Å ${QUESTIONS.length+1}`);

/* ========= —Ç–æ–∫–µ–Ω/–∏–Ω–∏—Ü–∏–∞–ª—ã ========= */
const params = new URL(location.href).searchParams;
const token  = params.get("token") || "DEMO-TOKEN";
document.getElementById("utoken").textContent = token;
(function(){
  const t = token.replace(/[^a-zA-Z–ê-–Ø–∞-—è0-9]/g,"").toUpperCase();
  const ini = (t[0]||"A")+(t[1]||"B");
  document.getElementById("avatar").textContent = ini;
})();

/* ========= helpers ========= */
const LS = (k,v)=> v===undefined ? localStorage.getItem(k) : localStorage.setItem(k,v);
const debouncers = {};
function debounce(id, fn, ms=500){
  clearTimeout(debouncers[id]);
  debouncers[id] = setTimeout(fn, ms);
}

/* ========= –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ ========= */
const qlist = document.getElementById("qlist");
const total = QUESTIONS.length;
document.getElementById("total").textContent = total;

function renderQuestions(){
  qlist.innerHTML = "";
  QUESTIONS.forEach((q, i)=>{
    const saved = LS(keyAns(i)) || "";
    const done = saved.trim().length>=3;
    const open = (i===0); // –ø–µ—Ä–≤—ã–π –æ—Ç–∫—Ä—ã—Ç
    qlist.insertAdjacentHTML("beforeend", `
      <div class="q" data-i="${i}">
        <div class="qh" onclick="toggleQ(${i})">
          <div><span class="num">${i+1} / ${total}</span> ‚Äî ${q}</div>
          <div>${done? "‚úÖ":"‚ñ∏"}</div>
        </div>
        <div class="qa" id="qa_${i}" style="display:${open?'block':'none'}">
          <textarea id="ta_${i}" placeholder="–í–∞—à —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç...">${saved}</textarea>
          <div class="hint">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Ä¢ –ü–æ–¥—Å–∫–∞–∑–∫–∏:</div>
          <div class="tags">
            <div class="tag" onclick="ins(${i}, '–í—Å–ø–æ–º–∏–Ω–∞—é, –∫–∞–∫ –º—ã...')">–í—Å–ø–æ–º–∏–Ω–∞—é‚Ä¶</div>
            <div class="tag" onclick="ins(${i}, '–û—Å–æ–±–µ–Ω–Ω–æ —Ç—Ä–æ–Ω—É–ª –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞...')">–¢—Ä–æ–Ω—É–ª –º–æ–º–µ–Ω—Ç‚Ä¶</div>
            <div class="tag" onclick="ins(${i}, '–Ø –ø–æ–Ω—è–ª(–∞), —á—Ç–æ —ç—Ç–æ –ª—é–±–æ–≤—å, –∫–æ–≥–¥–∞...')">–≠—Ç–æ –ª—é–±–æ–≤—å‚Ä¶</div>
          </div>
        </div>
      </div>
    `);
    const ta = document.getElementById(`ta_${i}`);
    ta.addEventListener("input", ()=>{
      debounce(`a${i}`, ()=>{
        LS(keyAns(i), ta.value);
        updateProgress();
      });
    });
    ta.addEventListener("keydown",(e)=>{
      if(document.body.classList.contains("pro")){
        if(e.key==="ArrowDown") {e.preventDefault(); openQ(i+1)}
        if(e.key==="ArrowUp")   {e.preventDefault(); openQ(i-1)}
        if(e.key==="Enter" && e.ctrlKey){e.preventDefault(); openQ(i+1)}
      }
    });
  });
}
function keyAns(i){ return `cab_${token}_a_${i}` }
function toggleQ(i){
  const el = document.getElementById(`qa_${i}`);
  const is = el.style.display!=="none";
  if(is){ el.style.display="none"; }
  else{
    if(document.body.classList.contains("pro")){
      // –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
      document.querySelectorAll(".qa").forEach(x=>x.style.display="none");
    }
    el.style.display="block";
    document.getElementById(`ta_${i}`).focus({preventScroll:false});
    document.getElementById(`ta_${i}`).scrollIntoView({behavior:"smooth",block:"center"});
  }
}
function openQ(i){
  if(i<0||i>=total) return;
  document.querySelectorAll(".qa").forEach(x=>x.style.display="none");
  const el = document.getElementById(`qa_${i}`);
  if(el){ el.style.display="block"; document.getElementById(`ta_${i}`).focus(); el.scrollIntoView({behavior:"smooth",block:"center"}); }
}
function ins(i, txt){
  const ta = document.getElementById(`ta_${i}`);
  ta.value = (ta.value ? ta.value+"\n" : "") + txt;
  LS(keyAns(i), ta.value);
  updateProgress();
}

/* ========= –ø—Ä–æ–≥—Ä–µ—Å—Å ========= */
function updateProgress(){
  let done = 0;
  for(let i=0;i<total;i++){
    if((LS(keyAns(i))||"").trim().length>=3) done++;
  }
  document.getElementById("done").textContent = done;
  const per = done/total;
  const C = 2*Math.PI*18; // –¥–ª–∏–Ω–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ r=18 (‚âà113.1)
  document.getElementById("pfg").style.strokeDasharray = C;
  document.getElementById("pfg").style.strokeDashoffset = C*(1-per);
}
renderQuestions(); updateProgress();

/* ========= covers ========= */
const covers = document.getElementById("covers");
const savedCover = LS(`cab_${token}_cover`) || "gold";
[...covers.querySelectorAll("input")].forEach(i=>{
  i.checked = (i.value===savedCover);
  if(i.checked) i.closest(".cover").classList.add("selected");
  i.addEventListener("change", ()=>{
    [...covers.querySelectorAll(".cover")].forEach(c=>c.classList.remove("selected"));
    i.closest(".cover").classList.add("selected");
    LS(`cab_${token}_cover`, i.value);
  });
});

/* ========= Pro mode ========= */
const proToggle = document.getElementById("proToggle");
(function initPro(){
  const on = LS(`cab_${token}_pro`) === "1";
  proToggle.checked = on;
  document.body.classList.toggle("pro", on);
})();
proToggle.onchange = ()=>{
  const on = proToggle.checked;
  LS(`cab_${token}_pro`, on?"1":"0");
  document.body.classList.toggle("pro", on);
};

/* ========= finish & send ========= */
// –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –Ω–∞ /api/finish (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–ø–∞–∫—É–π –≤ ZIP + —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
document.getElementById("finish").onclick = async ()=>{
  const answers = [];
  for(let i=0;i<total;i++) answers.push({i, q:QUESTIONS[i], a:LS(keyAns(i))||""});
  const payload = { token, cover: LS(`cab_${token}_cover`)||"gold", answers };

  try{
    const r = await fetch("/api/finish",{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error("finish failed");
    alert("–ì–æ—Ç–æ–≤–æ! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç—ã. –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è üíå");
  }catch(e){
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
};

/* ========= support chat ========= */
const chatFab  = document.getElementById("chatFab");
const chatBox  = document.getElementById("chatBox");
const chatSend = document.getElementById("chatSend");
const chatClose= document.getElementById("chatClose");
const chatIn   = document.getElementById("chatInput");
const chatMsg  = document.getElementById("chatMessages");

chatFab.onclick = ()=> chatBox.style.display="flex";
chatClose.onclick = ()=> chatBox.style.display="none";
chatSend.onclick = sendMsg;
chatIn.addEventListener("keydown",e=>{ if(e.key==="Enter"){e.preventDefault(); sendMsg();} });

function sendMsg(){
  const t = chatIn.value.trim(); if(!t) return;
  pushMsg("you",t); chatIn.value="";
  fetch("/api/support",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token,message:t})})
    .catch(()=>{ pushMsg("sys","–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."); });
}
function pushMsg(who, text){
  const d=document.createElement("div"); d.className="msg "+who; d.textContent=text;
  chatMsg.appendChild(d); chatMsg.scrollTop = chatMsg.scrollHeight;
}
</script>
</body>
</html>