<!DOCTYPE html>
<html lang="ru" data-theme="auto">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî –ò—Å—Ç–æ—Ä–∏—è</title>

<link href="https://fonts.googleapis.com/css2?family=Spectral+SC:wght@400;600;700&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{ --bg:#FBF7F2; --ink:#4A3A39; --glass:rgba(255,255,255,.84); --gold2:#c7a875; --gold3:#9c7b55; }
:root[data-theme="dark"]{ --bg:#14110E; --ink:#E8DCCB; --glass:rgba(28,24,21,.76); }
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:var(--bg) url("assets/background4.jpg") center/cover fixed no-repeat;
  color:var(--ink); font-family:"Playfair Display",serif;
  min-height:100vh; padding:72px 10px 90px;
}
/* header */
.header{ position:fixed; inset:0 0 auto 0; z-index:50; display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; backdrop-filter:blur(10px); }
.brand{ display:flex; gap:10px; align-items:center }
.brand .pill{ width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.55);border:1px solid rgba(255,255,255,.35);
  display:flex;align-items:center;justify-content:center }
.brand .name{ font-family:"Spectral SC",serif;font-weight:600;
  background:linear-gradient(100deg,#7a5e49,#c9a876,#ecd8b8);-webkit-background-clip:text;color:transparent }
.theme{ width:38px;height:38px;border-radius:50%; background:rgba(255,255,255,.55); display:flex;align-items:center;justify-content:center;
  cursor:pointer; border:1px solid rgba(255,255,255,.35) }
.wrap{ max-width:980px; margin:0 auto; display:grid; gap:18px }

/* cards */
.card{ background:var(--glass); border-radius:22px; padding:20px; box-shadow:0 12px 30px rgba(0,0,0,.12); backdrop-filter:blur(10px) }
.card h2{ font-family:"Spectral SC",serif; margin-bottom:8px;
  background:linear-gradient(100deg,#7a5e49,#c9a876,#ecd8b8);-webkit-background-clip:text;color:transparent }
.sub{ opacity:.85; margin-bottom:12px }

/* profile row */
.profile{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
.profile input{ padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.08); background:rgba(255,255,255,.9) }

/* QA */
.qa{ display:flex; flex-direction:column; gap:12px; max-height:56vh; overflow:auto; padding-right:6px }
.qitem{ background:rgba(255,255,255,.7); border-radius:14px; padding:12px }
.qitem h4{ font-size:16px; margin-bottom:6px }
.qitem textarea{ width:100%; min-height:90px; border:none; border-radius:12px; padding:10px; font-size:16px; background:rgba(255,255,255,.92) }

/* photos */
.upload{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
.input-file{ display:none }
.btn{
  border:none; cursor:pointer; color:#fff; font-weight:700;
  background:linear-gradient(130deg,var(--gold2),var(--gold3));
  padding:12px 22px; border-radius:999px; font-size:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.15); transition:.25s;
}
.btn:hover{ transform:translateY(-2px); opacity:.96 }
.preview{ margin-top:10px; display:flex; flex-wrap:wrap; gap:10px }
.thumb{ width:86px; height:86px; border-radius:12px; overflow:hidden; position:relative; box-shadow:0 6px 16px rgba(0,0,0,.16) }
.thumb img{ width:100%; height:100%; object-fit:cover }
.thumb .x{ position:absolute; top:6px; right:6px; width:20px; height:20px; font-size:12px; border-radius:50%;
  background:rgba(0,0,0,.65); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer }

/* designs */
.designs{ display:flex; gap:10px; flex-wrap:wrap }
.designs label{ display:flex; gap:8px; align-items:center; background:rgba(255,255,255,.7); padding:8px 12px; border-radius:12px }

/* bar */
.bar{ position:fixed; left:0; right:0; bottom:0; z-index:40; display:flex; gap:10px; justify-content:center; padding:10px; backdrop-filter:blur(10px) }
.bar .btn{ padding:12px 18px }

/* support */
.support{ position:fixed; right:12px; bottom:70px; width:320px; max-width:92vw; background:var(--glass); border-radius:14px; padding:10px;
  box-shadow:0 10px 24px rgba(0,0,0,.16); display:none; z-index:60 }
.support .log{ max-height:220px; overflow:auto; padding:6px; background:rgba(255,255,255,.6); border-radius:10px; margin-bottom:8px }
.support .row{ display:flex; gap:6px }
.support input{ flex:1; padding:10px; border:none; border-radius:999px; background:rgba(255,255,255,.85) }
.fab{ position:fixed; right:12px; bottom:12px; z-index:55; width:54px; height:54px; border-radius:50%;
  background:linear-gradient(130deg,var(--gold2),var(--gold3)); color:#fff; display:flex; align-items:center; justify-content:center;
  cursor:pointer; box-shadow:0 12px 28px rgba(0,0,0,.2) }

@media(max-width:640px){ .qa{ max-height:52vh } }
</style>
</head>
<body>

<header class="header">
  <div class="brand">
    <div class="pill">üìñ</div>
    <div class="name">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
  </div>
  <div class="theme" id="themeBtn">üåô</div>
</header>

<main class="wrap">
  <!-- –ü–†–û–§–ò–õ–¨ -->
  <section class="card">
    <h2>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
    <div class="sub">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram –Ω–∏–∫ (—á—Ç–æ–±—ã –º—ã —Å–≤—è–∑–∞–ª–∏—Å—å):</div>
    <div class="profile">
      <input id="tgUser" placeholder="@username">
      <span id="sessionInfo" style="opacity:.7"></span>
    </div>
  </section>

  <!-- –ü–†–û–ì–†–ï–°–° -->
  <section class="card">
    <h2>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
    <div class="sub">–û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ –∏ –≤—ã–±–∏—Ä–∞–π—Ç–µ –¥–∏–∑–∞–π–Ω. –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    <div id="status">–û—Ç–≤–µ—Ç–æ–≤: 0 / 100 ¬∑ –§–æ—Ç–æ: 0 ¬∑ –î–∏–∑–∞–π–Ω: –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
  </section>

  <!-- –í–û–ü–†–û–°–´ -->
  <section class="card">
    <h2>–í–æ–ø—Ä–æ—Å—ã</h2>
    <div class="qa" id="qa"></div>
  </section>

  <!-- –§–û–¢–û -->
  <section class="card">
    <h2>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
    <div class="sub">–ü–æ –∂–µ–ª–∞–Ω–∏—é. –û–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –∞—Ä—Ö–∏–≤ –≤–º–µ—Å—Ç–µ —Å –æ—Ç–≤–µ—Ç–∞–º–∏.</div>
    <div class="upload">
      <label class="btn">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ<input id="files" class="input-file" type="file" multiple accept="image/*"></label>
      <button class="btn" id="clearPhotos">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div class="preview" id="preview"></div>
  </section>

  <!-- –î–ò–ó–ê–ô–ù -->
  <section class="card">
    <h2>–î–∏–∑–∞–π–Ω –∫–Ω–∏–≥–∏</h2>
    <div class="sub">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å (–ø—Ä–∏–º–µ—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π, –¥–æ–±–∞–≤–∏–º –ø—Ä–µ–≤—å—é).</div>
    <div class="designs" id="designs">
      <label><input type="radio" name="design" value="classic"> Classic</label>
      <label><input type="radio" name="design" value="pudra"> Wedding Pudra Luxe</label>
      <label><input type="radio" name="design" value="silver"> Silver Grain</label>
      <label><input type="radio" name="design" value="minimal"> Minimal White</label>
    </div>
  </section>
</main>

<!-- –ù–ò–ñ–ù–ò–ô –ë–ê–† -->
<div class="bar">
  <button class="btn" id="saveDraft">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
  <button class="btn" id="finish">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –∫–Ω–∏–≥—É</button>
</div>

<!-- –ú–ò–ù–ò-–ß–ê–¢ –ü–û–î–î–ï–†–ñ–ö–ò -->
<div class="support" id="supportBox">
  <div class="log" id="supportLog"></div>
  <div class="row">
    <input id="supportInput" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..." />
    <button class="btn" id="supportSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>
<div class="fab" id="supportFab">üí¨</div>

<script>
/* ===== –¢–ï–ú–ê ===== */
const themeBtn=document.getElementById('themeBtn');
function setTheme(m){document.documentElement.setAttribute('data-theme',m);localStorage.setItem('cab_theme',m);themeBtn.textContent=m==='dark'?'‚òÄÔ∏è':'üåô'}
(function(){const s=localStorage.getItem('cab_theme');if(s){setTheme(s)}else{setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light')}})();
themeBtn.onclick=()=>setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

/* ===== –°–ï–°–°–ò–Ø/–î–ê–ù–ù–´–ï ===== */
const session = new URLSearchParams(location.search).get('session') || localStorage.getItem('session_uid') || 'guest';
document.getElementById('sessionInfo').textContent = `–°–µ—Å—Å–∏—è: ${session}`;
const LS_KEY = `cab_draft_${session}`;
const state = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
state.answers = state.answers || {};
state.photos = state.photos || []; // base64
state.design = state.design || '';
state.username = state.username || '';

/* ===== –í–û–ü–†–û–°–´ (1‚Äì100) ===== */
const QUESTIONS = [
  "–ì–¥–µ –≤—ã –≤–ø–µ—Ä–≤—ã–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å?","–ß—Ç–æ –≤—ã –ø–æ–¥—É–º–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –≤—Å—Ç—Ä–µ—á–µ?","–ö—Ç–æ —Å–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π —à–∞–≥?","–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Å—Ç–∞–ª —Ä–µ—à–∞—é—â–∏–º?","–ß—Ç–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å?",
  "–ì–¥–µ –ø—Ä–æ—à–ª–æ –≤–∞—à–µ –ø–µ—Ä–≤–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ?","–ß—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏ –ø–µ—Ä–µ–¥ –≤—Å—Ç—Ä–µ—á–µ–π?","–ö—Ç–æ –≤—ã–±–∏—Ä–∞–ª –º–µ—Å—Ç–æ?","–ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É, –Ω–æ —Å—Ç–∞–ª–æ –º–∏–ª—ã–º –º–æ–º–µ–Ω—Ç–æ–º?","–ö–∞–∫–æ–π –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–≤–∏–¥–∞–Ω–∏—è –∑–∞–ø–æ–º–Ω–∏–ª—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞?",
  "–ö—Ç–æ –ø–µ—Ä–≤—ã–º –ø—Ä–∏–∑–Ω–∞–ª—Å—è –≤ —Å–∏–º–ø–∞—Ç–∏–∏?","–ö–∞–∫–∞—è –ø–µ—Å–Ω—è –∏–ª–∏ —Ñ–∏–ª—å–º –∞—Å—Å–æ—Ü–∏–∏—Ä—É—é—Ç—Å—è —Å –ø–µ—Ä–≤—ã–º–∏ –≤—Å—Ç—Ä–µ—á–∞–º–∏?","–ö–∞–∫–∞—è —Ñ—Ä–∞–∑–∞ –∏–ª–∏ –ø–æ—Å—Ç—É–ø–æ–∫ —Ç–æ–≥–¥–∞ –æ—Å–æ–±–µ–Ω–Ω–æ —Ç—Ä–æ–Ω—É–ª–∏?","–ö–æ–≥–¥–∞ –≤—ã –≤–ø–µ—Ä–≤—ã–µ –ø–æ–Ω—è–ª–∏, —á—Ç–æ –≤–ª—é–±–ª–µ–Ω—ã?","–ö–∞–∫–æ–π –∑–∞–ø–∞—Ö, –≤–∫—É—Å –∏–ª–∏ –∑–≤—É–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ –Ω–∞—á–∞–ª–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π?",
  // ‚Ä¶ –î–æ–±–∞–≤—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–æ 100 –ø–æ —Ç–≤–æ–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≥–ª–∞–≤ (–º–æ–∂–Ω–æ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ)
];

/* ===== –†–ï–ù–î–ï–† ===== */
const qa = document.getElementById('qa');
function renderQuestions(){
  qa.innerHTML='';
  QUESTIONS.forEach((q,idx)=>{
    const i=idx+1, v=state.answers[i] || '';
    const el=document.createElement('div'); el.className='qitem';
    el.innerHTML = `<h4>${i}. ${q}</h4><textarea data-id="${i}" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">${v}</textarea>`;
    qa.appendChild(el);
  });
}
renderQuestions();

/* ===== HANDLERS ===== */
qa.addEventListener('input',(e)=>{
  if(e.target.tagName==='TEXTAREA'){
    state.answers[e.target.dataset.id]=e.target.value;
    sync(); updateStatus();
  }
});
document.getElementById('designs').addEventListener('change',(e)=>{
  if(e.target.name==='design'){ state.design=e.target.value; sync(); updateStatus(); }
});
const tgUser=document.getElementById('tgUser');
tgUser.value = state.username || '';
tgUser.addEventListener('input',()=>{ state.username = tgUser.value.trim(); sync(); });

function answeredCount(){ return Object.values(state.answers).filter(v=>v && v.trim().length>0).length; }
function updateStatus(){ document.getElementById('status').textContent = `–û—Ç–≤–µ—Ç–æ–≤: ${answeredCount()} / 100 ¬∑ –§–æ—Ç–æ: ${state.photos.length} ¬∑ –î–∏–∑–∞–π–Ω: ${state.design || '–Ω–µ –≤—ã–±—Ä–∞–Ω'}`; }
function sync(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
updateStatus();

/* ===== –§–û–¢–û ===== */
const filesInput=document.getElementById('files');
const previewBox=document.getElementById('preview');
filesInput.onchange=(e)=>{
  for(const f of e.target.files){
    const rr=new FileReader();
    rr.onload=()=>{ state.photos.push(rr.result); sync(); drawPhotos(); updateStatus(); };
    rr.readAsDataURL(f);
  }
  filesInput.value="";
};
document.getElementById('clearPhotos').onclick=()=>{ state.photos=[]; sync(); drawPhotos(); updateStatus(); }
function drawPhotos(){
  previewBox.innerHTML='';
  state.photos.forEach((b64,idx)=>{
    const el=document.createElement('div'); el.className='thumb';
    el.innerHTML = `<img src="${b64}"><div class="x" onclick="delPhoto(${idx})">‚úñ</div>`;
    previewBox.appendChild(el);
  });
}
window.delPhoto=(i)=>{ state.photos.splice(i,1); sync(); drawPhotos(); updateStatus(); }
drawPhotos();

/* ===== –ß–ï–†–ù–û–í–ò–ö ===== */
document.getElementById('saveDraft').onclick=()=>{ sync(); alert('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ'); }

/* ===== –§–ò–ù–ò–®: ZIP ‚Üí TG ===== */
document.getElementById('finish').onclick = async ()=>{
  if(!state.username){ alert("–£–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram @username, —á—Ç–æ–±—ã –º—ã —Å–≤—è–∑–∞–ª–∏—Å—å üôÇ"); return; }

  const zip = new JSZip();
  const answersArr=[];
  for(let i=1;i<=100;i++){
    const q = QUESTIONS[i-1] || `–í–æ–ø—Ä–æ—Å ${i}`;
    const a = state.answers[i] || '';
    answersArr.push(`${i}. ${q}\n${a}\n`);
  }
  const answersTxt = answersArr.join('\n----------------------\n\n');
  const meta = {
    session,
    username: state.username,
    design: state.design || null,
    answered: answeredCount(),
    photos: state.photos.length,
    created_at: new Date().toISOString()
  };

  zip.file('answers.txt', answersTxt);
  zip.file('meta.json', JSON.stringify(meta,null,2));

  const photosFolder = zip.folder('photos');
  (state.photos||[]).forEach((b64,idx)=>{
    const base64 = b64.split(',')[1];
    photosFolder.file(`photo_${String(idx+1).padStart(2,'0')}.jpg`, base64, {base64:true});
  });

  const blob = await zip.generateAsync({type:'blob'});
  const fd = new FormData();
  fd.append('zip', blob, `order_${session}.zip`);
  fd.append('caption', `üÜï –ó–∞–∫–∞–∑\n@${state.username || '-'} ¬∑ session: ${session}\n–û—Ç–≤–µ—Ç–æ–≤: ${answeredCount()} ¬∑ –§–æ—Ç–æ: ${state.photos.length}\n–î–∏–∑–∞–π–Ω: ${state.design || '-'}`);

  const r = await fetch('/api/sendZip',{method:'POST', body:fd});
  if(r.ok){
    alert('–ì–æ—Ç–æ–≤–æ! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à –∑–∞–∫–∞–∑. –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –≤ Telegram ü§ç');
    // localStorage.removeItem(LS_KEY); // –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –æ—á–∏—Å—Ç–∫—É
  }else{
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.');
  }
};

/* ===== –ü–û–î–î–ï–†–ñ–ö–ê ===== */
const supportFab=document.getElementById('supportFab');
const supportBox=document.getElementById('supportBox');
const supportLog=document.getElementById('supportLog');
const supportInput=document.getElementById('supportInput');
supportFab.onclick=()=>{ supportBox.style.display = (supportBox.style.display==='block'?'none':'block'); };
document.getElementById('supportSend').onclick=async()=>{
  const text=supportInput.value.trim(); if(!text) return;
  supportLog.innerHTML += `<div>–í—ã: ${text}</div>`;
  supportInput.value='';
  await fetch('/api/supportMessage',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session, text, username: state.username||''})});
};
</script>
</body>
</html>

